# Layer 0 Initial Scan Configuration
# Dynamic Variables:
# {target}     - Raw target input (IP, hostname, or URL)
# {domain}     - Extracted domain from target (e.g., example.com from https://www.example.com)
# {root_domain} - Root domain (e.g., example.com from sub.example.com)
# {subdomain}  - Subdomain part only (e.g., www from www.example.com)
# {ip}         - IP address if target is an IP, or resolved IP if hostname
# {port_80}    - Include command only if port 80 is open
# {port_443}   - Include command only if port 443 is open
# {tld}        - Top level domain (e.g., com from example.com)
# {no_scheme}  - URL without scheme (e.g., www.example.com from https://www.example.com)

# Target transformation patterns
transformations:
  domain:
    pattern: "^(?:https?://)?(?:www\\.)?([^/]+)"
    group: 1
  root_domain:
    pattern: "(?:[^.]+\\.)*([^.]+\\.[^.]+)$"
    group: 1
  subdomain:
    pattern: "^(?:https?://)?([^.]+)\\."
    group: 1
  tld:
    pattern: "\\.([^.]+)$"
    group: 1
  no_scheme:
    pattern: "^(?:https?://)?(.*)"
    group: 1

host_mode:
  commands:
    - name: "nmap_full_scan"
      description: "Full port scan with service version detection and default scripts"
      command: "nmap -sC -sV --top-ports 1000 -oX scan.xml {target}"
      timeout: 7200  # 2 hours
      required: true # This scan must complete for the workflow to continue
      conditions:
        - type: "always"  # Always run this command

    - name: "feroxbuster_http"
      description: "Directory enumeration if HTTP service is discovered"
      command: "feroxbuster --url http://{target}"
      timeout: 900  # 15 minutes
      required: false
      conditions:
        - type: "port_open"
          port: 80

    - name: "feroxbuster_https"
      description: "Directory enumeration if HTTPS service is discovered"
      command: "feroxbuster --url https://{target}"
      timeout: 900
      required: false
      conditions:
        - type: "port_open"
          port: 443

    - name: "nikto_web_scan"
      description: "Web vulnerability scan if HTTP/HTTPS is open"
      command: "nikto -h {target}"
      timeout: 1200  # 20 minutes
      required: false
      conditions:
        - type: "port_open"
          port: 80
        - type: "port_open"
          port: 443

    - name: "sql_server_probe"
      description: "Probe Microsoft SQL Server if port 1433 is open"
      command: "sqsh -S {target} -U sa -P <password>"
      timeout: 600
      required: false
      conditions:
        - type: "port_open"
          port: 1433

    - name: "mysql_enum"
      description: "MySQL enumeration if port 3306 is open"
      command: "mysql -h {target} -u root -p"
      timeout: 600
      required: false
      conditions:
        - type: "port_open"
          port: 3306

    - name: "smb_enum"
      description: "SMB enumeration if port 445 is open"
      command: "enum4linux -a {target}"
      timeout: 900
      required: false
      conditions:
        - type: "port_open"
          port: 445

    - name: "rpc_enum"
      description: "RPC enumeration if port 135 is open"
      command: "rpcclient -U '' {target}"
      timeout: 600
      required: false
      conditions:
        - type: "port_open"
          port: 135

    - name: "ftp_enum"
      description: "FTP anonymous login check if port 21 is open"
      command: "ftp -inv {target}"
      timeout: 600
      required: false
      conditions:
        - type: "port_open"
          port: 21

    - name: "ssh_enum"
      description: "SSH version enumeration if port 22 is open"
      command: "ssh -v {target}"
      timeout: 600
      required: false
      conditions:
        - type: "port_open"
          port: 22

    - name: "smtp_enum"
      description: "SMTP user enumeration if port 25 is open"
      command: "smtp-user-enum -M VRFY -U /usr/share/wordlists/user.txt -t {target}"
      timeout: 900
      required: false
      conditions:
        - type: "port_open"
          port: 25

    - name: "snmp_enum"
      description: "SNMP enumeration if port 161 is open"
      command: "snmpwalk -v2c -c public {target}"
      timeout: 600
      required: false
      conditions:
        - type: "port_open"
          port: 161

    - name: "winrm_enum"
      description: "WinRM probe if port 5985 is open"
      command: "evil-winrm -i {target} -u administrator -p <password>"
      timeout: 900
      required: false
      conditions:
        - type: "port_open"
          port: 5985

website_mode:
  commands:
    - name: "whatweb_scan"
      description: "Web technology and CMS detection"
      command: "whatweb {target}"
      timeout: 300  # 5 minutes
      required: true
      conditions:
        - type: "always"

    - name: "subfinder_root_domain"
      description: "Subdomain enumeration on root domain"
      command: "subfinder -d {root_domain}"
      timeout: 600  # 10 minutes
      required: false
      conditions:
        - type: "always"

# Condition types supported:
# - "always": Always run the command
# - "has_subdomain": Run only if target has a subdomain
# - "is_ip": Run only if target is an IP address
# - "port_open": Run only if specified port is open
# - "custom_regex": Run only if target matches custom regex pattern
#
# Example custom_regex usage:
# conditions:
#   - type: "custom_regex"
#     pattern: "^https?://[^/]+\\.edu\\." # Only run on .edu domains
#   - type: "custom_regex"
#     pattern: "^192\\.168\\." # Only run on 192.168.* IP addresses
#   - type: "custom_regex"
#     pattern: "^(?!www\\.).*\\.com$" # Run on .com domains except www.

# Global configuration
global:
  max_retries: 2  # Maximum number of retries for failed commands
  parallel: false # Whether to run commands in parallel (future feature)
  dns_resolver: "8.8.8.8"  # Default DNS resolver for lookups
  timeout_multiplier: 1.5  # Multiplier for timeouts on retry
